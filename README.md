# learning-woodpecker-ci
Using [Woodpecker CI](https://woodpecker-ci.org/) self-hosted with [Codeberg](https://codeberg.org/) self-hosted runner.  

# runner
https://forgejo.org/docs/next/admin/actions/#forgejo-runner  

Forgejo give almost everything that you need  
```
wget -O forgejo-runner https://code.forgejo.org/forgejo/runner/releases/download/v3.3.0/forgejo-runner-3.3.0-linux-amd64
chmod +x forgejo-runner
wget -O forgejo-runner.asc https://code.forgejo.org/forgejo/runner/releases/download/v3.3.0/forgejo-runner-3.3.0-linux-amd64.asc
gpg --keyserver keys.openpgp.org --recv EB114F5E6C0DC2BCDD183550A4B61A2DC5923710
gpg --verify forgejo-runner.asc forgejo-runner
```

But doesn't tell you that you need to register too  
```
./forgejo-runner register
```

**Forgejo instance URL**: https://codeberg.org  
**Runner token**: Get at your organization "Settings > Actions > Runners"  
The rest is up to you to fill or not.  

Start runner with  
```
sudo ./forgejo-runner daemon
```

# application
Create an application at your organization "Settings > Applications"  

**Redirect URIs**: `https://your-ip:8000`  

Note `https://your-ip:8000` is just an example  
Save "Client ID" and "Client Secret" to use with woodpecker ci  

# woodpecker ci

[Using there docker-compose as base](https://woodpecker-ci.org/docs/administration/deployment/docker-compose)  

Replace GITHUB by GITEA  
Replace `${WOODPECKER_HOST}` by `https://your-ip:8000`  
Replace `${WOODPECKER_GITHUB_CLIENT}` by the application "Client ID"  
Replace `${WOODPECKER_GITHUB_SECRET}` by the application "Client Secret"  
Replace `${WOODPECKER_AGENT_SECRET}` by the random string generated by `openssl rand -hex 32`  
```
version: '3'

services:
  woodpecker-server:
    image: woodpeckerci/woodpecker-server:latest
    ports:
      - 8000:8000
    volumes:
      - woodpecker-server-data:/var/lib/woodpecker/
    environment:
      - WOODPECKER_OPEN=true
      - WOODPECKER_HOST=${WOODPECKER_HOST}
      - WOODPECKER_GITEA=true
      - WOODPECKER_GITEA_CLIENT=${WOODPECKER_GITHUB_CLIENT}
      - WOODPECKER_GITEA_SECRET=${WOODPECKER_GITHUB_SECRET}
      - WOODPECKER_AGENT_SECRET=${WOODPECKER_AGENT_SECRET}

  woodpecker-agent:
    image: woodpeckerci/woodpecker-agent:latest
    command: agent
    restart: always
    depends_on:
      - woodpecker-server
    volumes:
      - woodpecker-agent-config:/etc/woodpecker
      - /var/run/docker.sock:/var/run/docker.sock
    environment:
      - WOODPECKER_SERVER=woodpecker-server:9000
      - WOODPECKER_AGENT_SECRET=${WOODPECKER_AGENT_SECRET}

volumes:
  woodpecker-server-data:
  woodpecker-agent-config:
```
